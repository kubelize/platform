apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: flux-system
spec:
  interval: 10m
  targetNamespace: argocd
  chart:
    spec:
      chart: argo-cd
      version: 9.4.0
      sourceRef:
        kind: HelmRepository
        name: argocd
        namespace: flux-system
  values:
    fullnameOverride: argocd
    crds:
      enabled: true
    configs:
      params:
        server.insecure: true
        server.disable.auth: true
      cm:
        kustomize.buildOptions: --load-restrictor LoadRestrictionsNone
        resource.exclusions: |
          ### Network resources created by the Kubernetes control plane and excluded to reduce the number of watched events and UI clutter
          - apiGroups:
            - ''
            - discovery.k8s.io
            kinds:
            # - Endpoints
            - EndpointSlice
          ### Internal Kubernetes resources excluded reduce the number of watched events
          - apiGroups:
            - coordination.k8s.io
            kinds:
            - Lease
          ### Internal Kubernetes Authz/Authn resources excluded reduce the number of watched events
          - apiGroups:
            - authentication.k8s.io
            - authorization.k8s.io
            kinds:
            - SelfSubjectReview
            - TokenReview
            - LocalSubjectAccessReview
            - SelfSubjectAccessReview
            - SelfSubjectRulesReview
            - SubjectAccessReview
          ### Intermediate Certificate Request excluded reduce the number of watched events
          - apiGroups:
            - certificates.k8s.io
            kinds:
            - CertificateSigningRequest
          - apiGroups:
            - cert-manager.io
            kinds:
            - CertificateRequest
          ### Cilium internal resources excluded reduce the number of watched events and UI Clutter
          - apiGroups:
            - cilium.io
            kinds:
            - CiliumIdentity
            - CiliumEndpoint
            - CiliumEndpointSlice
          ### Kyverno intermediate and reporting resources excluded reduce the number of watched events and improve performance
          - apiGroups:
            - kyverno.io
            - reports.kyverno.io
            - wgpolicyk8s.io
            kinds:
            - PolicyReport
            - ClusterPolicyReport
            - EphemeralReport
            - ClusterEphemeralReport
            - AdmissionReport
            - ClusterAdmissionReport
            - BackgroundScanReport
            - ClusterBackgroundScanReport
            - UpdateRequest
        resource.customizations: |
          pkg.crossplane.io/Provider:
            health.lua: |
              hs = {}
              if obj.status == nil or obj.status.conditions == nil then
                hs.status = "Progressing"
                hs.message = "Waiting for status conditions"
                return hs
              end

              for i, condition in ipairs(obj.status.conditions) do
                if condition.type == "Healthy" then
                  if condition.status == "True" then
                    hs.status = "Healthy"
                  elseif condition.status == "False" then
                    hs.status = "Degraded"
                  else
                    hs.status = "Progressing"
                  end
                  hs.message = condition.message or ""
                  return hs
                end
              end

              for i, condition in ipairs(obj.status.conditions) do
                if condition.type == "Installed" then
                  if condition.status == "True" then
                    hs.status = "Healthy"
                  else
                    hs.status = "Progressing"
                  end
                  hs.message = condition.message or ""
                  return hs
                end
              end

              hs.status = "Progressing"
              hs.message = "No health conditions found"
              return hs
    global:
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
    controller:
        containerSecurityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - all
          readOnlyRootFilesystem: true
          runAsUser: 1001
          runAsGroup: 1001
    server:
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - all
        readOnlyRootFilesystem: true
        runAsUser: 1001
        runAsGroup: 1001
    dex:
      enabled: false
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - all
        readOnlyRootFilesystem: true
        runAsUser: 1001
        runAsGroup: 1001
    applicationSet:
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - all
        readOnlyRootFilesystem: true
        runAsUser: 1001
        runAsGroup: 1001
      allowAnyNamespace: true
    notifications:
      enabled: false
    repoServer:
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - all
        readOnlyRootFilesystem: true
        runAsUser: 1001
        runAsGroup: 1001
      volumes:
        - emptyDir: {}
          name: custom-tools
        - emptyDir: {}
          name: subst-tmp
        - emptyDir: {}
          name: subst-kubeconfig
        - name: subst-cmp-plugin
          configMap:
            name: argocd-subst-cmp
            items:
              - key: plugin.yaml
                path: plugin.yaml
        - name: ejson-keys
          secret:
            secretName: ejson-keys
      extraContainers:
        - name: cmp-subst
          args:
            - /var/run/argocd/argocd-cmp-server
            - --loglevel
            - info
          image: kubelize/subst-cmp:v1.0.9
          imagePullPolicy: Always
          env:
            # has to be equal or greater than 'server.repo.server.timeout.seconds' & 'controller.repo.server.timeout.seconds'
            - name: ARGOCD_EXEC_TIMEOUT
              value: "5m30s"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - all
            readOnlyRootFilesystem: true
            runAsUser: 1001
            runAsGroup: 1001
          resources:
            limits:
              cpu: 6000m
              memory: 4096Mi
            requests:
              cpu: 1500m
              memory: 128Mi
          volumeMounts:
            - mountPath: /var/run/argocd
              name: var-files
            - mountPath: /home/argocd/cmp-server/plugins
              name: plugins
            # Starting with v2.4, do NOT mount the same tmp volume as the repo-server container. The filesystem separation helps
            # mitigate path traversal attacks.
            - mountPath: /tmp
              name: subst-tmp
            - mountPath: /etc/kubernetes/
              name: subst-kubeconfig
            - mountPath: /home/argocd/cmp-server/config/plugin.yaml
              subPath: plugin.yaml
              name: subst-cmp-plugin
            - mountPath: /opt/ejson/keys
              name: ejson-keys
              readOnly: true

